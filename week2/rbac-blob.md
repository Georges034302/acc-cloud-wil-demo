# ğŸ” Demo Guide: Role-Based Access Control (RBAC) for Azure Blob Storage

## ğŸ¯ Objective

Experience Azure RBAC by attempting to upload a blob without permission, then assigning the correct role to allow access.

---

## ğŸ§­ Prerequisites

- Azure Portal access
- Azure CLI installed
- Two Azure AD users:
  - One with **Owner** or **Contributor** role (Instructor/Admin)
  - One with **no roles assigned** (Student/User)

---

## ğŸ‘£ Step-by-Step Instructions (Azure Portal + Azure CLI)

### 0ï¸âƒ£ Create Azure AD Users (Admin & Student)

ğŸ”¸ **Portal:**
1. Go to [https://portal.azure.com](https://portal.azure.com)
2. Search for and open **Microsoft Entra ID** (formerly Azure AD)
3. In the left menu, select **Users** â†’ Click **+ New user**
4. Create **Admin User**:
   - User name: `adminuser@<your_domain>`
   - Name: `Admin User`
   - Assign password or auto-generate
   - Click **Create**
5. Repeat to create **Student User**:
   - User name: `studentuser@<your_domain>`
   - Name: `Student User`
   - Do NOT assign any roles yet
6. After creation, go to **Subscriptions** â†’ Select your subscription
   - Click **Access control (IAM)** â†’ **+ Add** â†’ **Add role assignment**
   - Role: **Owner** or **Contributor**
   - Assign this role to the **Admin User** only

ğŸ”¸ **CLI:** *(Optional step if you prefer automation)*
```bash
az ad user create \
  --display-name "Admin User" \
  --user-principal-name adminuser@<your_domain> \
  --password <StrongPassword123> \
  --force-change-password-next-login true

az ad user create \
  --display-name "Student User" \
  --user-principal-name studentuser@<your_domain> \
  --password <StrongPassword123> \
  --force-change-password-next-login true

# Assign role to Admin User
az role assignment create \
  --assignee adminuser@<your_domain> \
  --role "Contributor" \
  --scope /subscriptions/<subscription_id>
```

ğŸ” **Login Tips:**
- After user creation, the default password (if autogenerated) will be shown once on the Portal. Copy and save it.
- Each user will receive an **invitation email** at their configured email address (if valid) to set their password.
- Alternatively, log in at [https://portal.azure.com](https://portal.azure.com) using the assigned username (e.g., `studentuser@<your_domain>`) and the initial password.
- On first login, Azure will prompt them to reset the password.
- Open **Incognito or Private Mode** in your browser to simulate the **student user login** without conflicting sessions.
- Use your regular browser tab to stay signed in as the **admin user** for provisioning and role assignment tasks.

> âš ï¸ Ensure the student user remains unprivileged until permissions are explicitly granted later in the demo. until permissions are explicitly granted later in the demo.

ğŸ”¸ **Portal:**
1. Go to [https://portal.azure.com](https://portal.azure.com)
2. Search for and open **Microsoft Entra ID** (formerly Azure AD)
3. In the left menu, select **Users** â†’ Click **+ New user**
4. Create **Admin User**:
   - User name: `adminuser@<your_domain>`
   - Name: `Admin User`
   - Assign password or auto-generate
   - Click **Create**
5. Repeat to create **Student User**:
   - User name: `studentuser@<your_domain>`
   - Name: `Student User`
   - Do NOT assign any roles yet
6. After creation, go to **Subscriptions** â†’ Select your subscription
   - Click **Access control (IAM)** â†’ **+ Add** â†’ **Add role assignment**
   - Role: **Owner** or **Contributor**
   - Assign this role to the **Admin User** only

ğŸ”¸ **CLI:** *(Optional step if you prefer automation)*
```bash
az ad user create \
  --display-name "Admin User" \
  --user-principal-name adminuser@<your_domain> \
  --password <StrongPassword123> \
  --force-change-password-next-login true

az ad user create \
  --display-name "Student User" \
  --user-principal-name studentuser@<your_domain> \
  --password <StrongPassword123> \
  --force-change-password-next-login true

# Assign role to Admin User
az role assignment create \
  --assignee adminuser@<your_domain> \
  --role "Contributor" \
  --scope /subscriptions/<subscription_id>
```

> âš ï¸ Ensure the student user remains unprivileged until permissions are explicitly granted later in the demo.

### 1ï¸âƒ£ Create Resource Group and Storage Account

ğŸ”¸ **Portal:**

1. Go to [https://portal.azure.com](https://portal.azure.com)
2. Search for **Storage accounts** â†’ Click **+ Create**
3. Fill in:
   - Subscription: your active subscription
   - Resource group: `rbacdemo-rg` (new or existing)
   - Storage account name: `rbacdemo<unique>`
   - Region: `Australia East`
   - Performance: Standard
   - Redundancy: LRS
4. Click **Review + create** â†’ **Create**

ğŸ”¸ **CLI:**

```bash
az group create --name rbacdemo-rg --location australiaeast

az storage account create \
  --name rbacdemo123 \
  --resource-group rbacdemo-rg \
  --location australiaeast \
  --sku Standard_LRS
```

---

### 2ï¸âƒ£ Enable Azure AD Authentication and Public Access Override

ğŸ”¸ **Portal Only:**

1. Go to your **Storage Account**
2. In the left menu, click **Settings** â†’ **Configuration**
3. Set **Default to Azure AD authorization in the Azure portal** to `Enabled`
4. Enable **Allow enabling public access override** if not already enabled
5. Click **Save**

> âš ï¸ This step ensures token-based authentication and permits container-level access control when public access is overridden.

> âš ï¸ This step is required so that the Portal and CLI default to token-based auth and to allow container-level access control.

---

### 3ï¸âƒ£ Create a Private Blob Container

ğŸ”¸ **Portal:**

1. Go to **Storage Account** â†’ **Containers** â†’ Click **+ Container**
2. Name: `myfiles` â†’ Access level: Private â†’ **Create**

ğŸ”¸ **CLI:**

```bash
az storage container create \
  --account-name rbacdemo123 \
  --name myfiles \
  --public-access off \
  --auth-mode login
```

---

### 4ï¸âƒ£ Attempt Upload Without Permissions âŒ

ğŸ”¸ **Portal:**

1. Open browser **Incognito Mode** â†’ Login as the **student user**
2. Go to **Storage Account** â†’ **Containers** â†’ `myfiles`
3. Click **Upload** â†’ select a file â†’ Click **Upload**
4. âŒ You will receive an **Unauthorized** error (expected)

ğŸ”¸ **CLI:**

```bash
az login  # Login as student user

az storage blob upload \
  --account-name rbacdemo123 \
  --container-name myfiles \
  --name test.txt \
  --file ./test.txt \
  --auth-mode login \
  --overwrite true
```

âš ï¸ Expected to fail due to lack of RBAC permissions.

---

### 5ï¸âƒ£ Assign Storage Blob Data Contributor Role âœ…

ğŸ”¸ **Portal:**

1. Login as **admin user**
2. Go to **Storage Account** â†’ **Access control (IAM)**
3. Click **+ Add** â†’ **Add role assignment**
4. Role: `Storage Blob Data Contributor` â†’ Click **Next**
5. Click **+ Select members** â†’ choose **student user**
6. Click **Select** â†’ **Next** â†’ **Review + assign** twice

ğŸ”¸ **CLI:**

```bash
az role assignment create \
  --assignee <student_email_or_object_id> \
  --role "Storage Blob Data Contributor" \
  --scope "/subscriptions/<subscription_id>/resourceGroups/rbacdemo-rg/providers/Microsoft.Storage/storageAccounts/rbacdemo123"
```

---

### 6ï¸âƒ£ Upload File Again (With Access) âœ…

ğŸ”¸ **Portal:**

1. Return to Portal as **student user**
2. Refresh the **Containers** â†’ `myfiles`
3. Click **Upload** â†’ select file â†’ âœ… Check **Overwrite if file exists** â†’ Click **Upload**
4. âœ… Upload will succeed

ğŸ”¸ **CLI:**

```bash
az storage blob upload \
  --account-name rbacdemo123 \
  --container-name myfiles \
  --name test.txt \
  --file ./test.txt \
  --auth-mode login \
  --overwrite true
```

âœ… Upload will succeed using token-based RBAC access.

---

### 7ï¸âƒ£ (Optional) Verify Blob Metadata

You can confirm the blob was written correctly using:

ğŸ”¸ **CLI:**

```bash
az storage blob show \
  --account-name rbacdemo123 \
  --container-name myfiles \
  --name test.txt \
  --auth-mode login
```

This displays blob metadata like size, last modified, and access tier.

---

## ğŸ§¼ Clean Up (Optional)

```bash
az group delete --name rbacdemo-rg --yes --no-wait
```

---

âœ… **Demo complete â€“ students have experienced RBAC enforcement with secure Azure AD-based access to Blob Storage!**

